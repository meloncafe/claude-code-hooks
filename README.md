# Claude Code Hooks

[English Version](README.en.md)

Claude Code를 API 시절부터 현재 Max 2x 요금제를 사용하면서 나름의 대규모 프로젝트를 진행하면서 가능한 “토큰을 소비하더라도 현명하게 소비”를 하고자 여러가지 시도를 해 보았고, 아마 올해까지는 이 방안을 계속 사용할 것 같기에 공유를 해 보고자 합니다.

개발은 약 10여년 이상 했고, 지금은 개발자라는 직업이 아닌 다른 직업을 가지고, 개인 사이드 프로젝트에서만 사용을 하지만 Anthropic이나 기타 LLM에 올 한해 약 $2000 정도 사용하고 나름의 결과물을 공유하고자 합니다.

## 1. Claude Code는 제한이 필요하다

Claude Code는 일반적인 상황에서는 아주 훌륭합니다.

하지만 거대한 Monorepo안에서 여러가지 패키지 모듈, 백엔드, 프론트엔드 등을 작업하다보면 Claude는 혼란이 오기 시작합니다.

정확하게는 이 거대한 공간에서 지금 어떤 프로젝트를 진행중인지, 이전 세션에서 어떤 프로젝트를 작업중이었는지, 테스트나 각 모듈별 사용법에 대해서 많은 혼란이 오기 시작합니다.

단일 프로젝트로 진행, 마이크로 서비스 등으로 분리, 하나의 프로젝트에는 하나의 Claude Code만 연결

이런 방법들이 조금 더 효율적이고 Claude의 혼란을 최소화 할 수 있겠지만 해당 방법을 전부 시도해 보았고 결국 Claude 자체에 제한이나 가이드가 필요하다는 판단을 내렸습니다.

## 2. Claude Code는 CLAUDE.md를 읽어는 준다

Claude Code를 프로젝트에 처음 실행시키면 /init 명령어를 통해 CLAUDE.md라는 프로젝트 전용 지침을 만들기를 권하는 메시지가 출력됩니다.

대부분의 Claude 사용자들이 그렇겠지만 CLAUDE.md파일을 생성하고, 여러가지 프로젝트에 맞는 지침을 넣고 있을겁니다.

하지만 Claude Code를 하나의 세션, 즉 한 개의 대화에서만 사용을 하고 끝낸다 라고 하면 크게 문제는 없지만, Anthropic에서 열심히 홍보하는 Auto Compect등의 컨텍스트 자동 압축, Claude Code CLI 메모리 문제로 인한 종료 후 다시 시작 등 이전 세션과 연결해서 작업을 진행하면 Claude Code는 CLAUDE.md를 무시하기 시작합니다.

특히 이 상황은 Auto Compact가 발생한 후에 매우 심각하며, Auto Compact 이후에는 CLAUDE.md에 적힌 내용을 참고조차 하지 않습니다.

이전 세션의 내용을 요약해서 다음 세션에 프롬프트로 넘겨주지만, 말 그대로 이전 세션에서 진행하던 내용으로 지침사항이나 해당 세션에서 어떤걸 제한했었는지, 사용자가 중간에 개입을 해서 어떤 지침을 했었는지는 제대로 알려주지 않습니다.

그렇기에 만약 하나의 코드 작업이 끝남과 동시에 Auto Compact가 발생하고 다음 세션으로 넘어가면 해당 세션의 Claude는 이전 세션에서 넘어온 프롬프트만으로 “자체 해석”을 하며 이미 끝난 코드임에도 잘못된 코드라며 지우거나 다시 처음부터 작업을 진행하는 아주 멍청한 행동을 하기 쉽상입니다.

## 3. Hook 기능은 쓰기 나름이다

Claude Code를 사용하면서 Hook 기능을 왜 이제서야 사용했는지 저 자신도 궁금합니다.

Markdown으로 입력한 지침은 Claude에게 “지침”을 내릴 수는 있지만 그걸 지킬지 지키지 않을지는 Claude 마음입니다.

하지만 Hook은 Claude Code에게 “강제성”을 만들어줄 수 있습니다.

아주 다양하게 사용할 수 있지만, 예를들자면 아래와 같은 정도가 있습니다.

1. 명령어 제한
2. 토큰 제한
3. 패턴 제한
4. 잘못된 행동에 대한 제한
5. 세션이 시작됐을 때 어떤걸 우선시 해야 하는지 명령

이 외에 여러가지 조합하기 나름이지만, 제가 사용했을때는 아주 유용했고 Claude가 제멋대로 날뛰는 부분을 상당부분 잡을 수 있었습니다.

현재 제가 사용중인 훅은 아래와 같습니다.

```
auto_compact.py
command_restrictor.py
context_recovery_helper.py
detect_session_finish.py
no_mock_code.py
pattern_enforcer.py
post_session_hook.py
post_tool_use_compact_progress.py
pre_session_hook.py
secret_scanner.py
session_start.py
timestamp_validator.py
token_manager.py
validate_git_commit.py
```

설명을 드리자면, 

1. 새로운 세션이 시작되던, 이전 세션에서 Auto Compact되어 들어오던 session_start 또는 pre_session_hook 을 통해 이전 세션 요약 정보를 보여줍니다.
    
    (요약에 대한 내용은 아래에서 자세히 다루겠습니다.)
    
2. Claude가 실행하는 모든 명령어는 command_restrictor를 먼저 통과해야 합니다.
여기에서 대부분의 잘못된 명령어 입력은 제한할 수 있습니다.
3. 현재 사용중인 토큰량을 체크합니다.
사용하는 토큰 수에 제한을 걸고 싶다면 이 부분에서 제한이 걸려 작업이 중단됩니다.
4. 하나의 작업이 완료되거나 코드를 수정했다면 secret_scanner, no_mock_code 등의 스크립트를 통해 기본적인 보안 검사 및 TODO로 남겨두고 실제로 구현하지 않은 항목들을 검사합니다.
Claude가 말은 구현했다고 하지만 TODO로 남겨두고 구현하지 않는 부분이 많습니다.
해당 부분을 강제성으로 구현하게 만들어줍니다.
5. 만약 Hook 설정에서 Auto Commit이 활성화 되어 있거나 Claude 자신이 Git Commit을 하겠다고 나서는 경우 개발자도 모르게 by Claude 등의 커밋 메시지가 엉망으로 커밋되어 있는 경우가 있습니다.
그렇기에 Claude가 git commit을 시도하면 validate_git_commit을 통과해야 합니다.
이 부분에서 잘못된 커밋 메시지 형식 또는 Co-Auth등의 필요없는 문구 제한을 통해 최대한 깔끔한 커밋 메시지를 작성하도록 합니다.

현재 구성되어 있는 Hook에서 가장 유용한 부분은 명령어 제한 부분과 Auto Compact 발생시에 이전 세션 요약본을 다음 세션에 명확하게 제공하는 부분입니다.

자동 컨텍스트 백업 및 다음세션에 대한 요약 제공은 간단하게 아래와 같은 플로우를 따릅니다.

Claude Auto Compact 발생 → PreCompactHook 실행 → Hook 스크립트에서 현재 컨텍스트 파일 백업 (Claude에서 제공된 JSONL 파일) → 해당 백업본에서 필요없는 부분 1차 정제(약 7-8Mb에서 100-200Kb로 감소) → 정제된 내용을 가지고 Claude Code CLI를 이용해서 Claude Haiku 4.5 모델을 통해 요약 작성 → 다음 세션에 요약된 내용을 세션 시작시에 표시하고 Claude에게 이전 세션에서 어떤 작업을 했는지, 다음에 어떤걸 해야 할지 알림

쓰고 보니까 간단하지는 않네요.

핵심은 현재 컨텍스트 원본을 가지고 실제로 필요한 부분만 빼낸 뒤 Claude에게 요약본 생성을 요청하고 해당 요약본을 다음 세션에 PreSession 등 세션 시작시에 요약본 제공을 함으로써 길어지는 작업을 조금 더 안정적으로 진행할 수 있다는 점에 대해 만족하고 있습니다.

명령어 제약 역시 Claude Code에서 발생하는 모든 명령어에 대해 감시하고 사용하면 안되는 명령어라던가 curl 또는 Claude Code에서 제공하는 permission 기능으로 제어할 수 없는 명령어들에 대해 유용합니다.

예를 들면 curl 같은 경우 Claude Code Settings에 Allow로 설정을 해도 매 번 사용해도 되는지 물어봅니다.

이는 매우 귀찮고 짜증스러우며 다른 방법을 제가 못찾은 걸수도 있겠지만, 대부분의 방법은 저한테 유용하지 않았습니다.

명령어 제한 스크립트를 통해 Allow/Deny/Ask를 확실하게 구분할 수 있으며 특정 명령어가 허용이 되어 있더라도 사용자에게 Ask로 넘길 수 있고 매번 허용해줘야 하는 명령어에 대해서 자동으로 Allow를 해줄 수 있습니다. 

(예를 들면 rm -rf가 Allow라도 이 스크립트를 사용하면 사용자에게 사용해도 되는지 물어보게 됩니다)

## 4. Skills 기능은 Hook과 같이 사용해야 한다

최근에 출시된 Claude Skills는 여러가지를 볼 수 있게 해주고 있습니다.

기존의 Agent 방식은 별도로 해당 Agent를 불러내야 하는 귀찮음이 있었지만 Skills는 Claude가 “나 이 기술 쓸 수 있어!” 라고 하는것과 마찬가지기에 구성만 잘해둔다면 [CLAUDE.md](http://CLAUDE.md) 파일이 3000줄이 넘어가는 상황을 방지할 수 있습니다.

하지만 Skills도 만능은 아닙니다.

해당 기능을 제대로 사용하기 위한 “가이드 라인”이지 이걸 제대로 지킬지 말지는 Claude 생각하기 나름입니다.

그렇기에 Skills로 백엔드, 프론트엔드, API, 기타 등등 여러가지 기술을 만들고 가지고 있어도 제대로된 제어를 할 수 없다면 있으나 마나 무용지물입니다.

## 5. 가능하면 프로젝트별 CLI를 구성해라

저는 프로젝트 대부분이 Python 기반으로 진행하며, 근래에는 FastAPI + React 기반의 작업이 많습니다.

Python/FastAPI 기준으로 말씀드리자면, Typer/Rich 라이브러리를 가지고 프로젝트에서 사용할 수 있는 CLI를 만들어 두는걸 추천합니다.

개발중에는 많은 작업을 해야 합니다. 

데이터 베이스 관리도 해야하고, API Spec관리도 해야하고, 테스트 할 때 테스트 계정 생성이나 권한 적용, 현재 실행중인 백엔드, 프론트엔드 등 여러가지 수작업으로 해야할일이 많습니다.

먼저 이런 수작업을 진행할 수 있는 CLI를 Claude Code를 이용해서 만들어두세요.

특히 데이터베이스에 직접 접근해서 수정해야 한다거나 직접 쿼리를 해야 하는 상황이 발생할 때 Claude는 거의 대부분 해당 데이터베이스의 CLI를 이용해서 접근을 하려고 할꺼고 매 번 접근할 수 있는 아이디와 비밀번호를 물어볼 것이며 알려줘도 제대로 작업을 못할겁니다.

이걸 수행할 수 있는 CLI를 만들어두고 해당 CLI에 대한 활용법을 Claude에게 알려주면 여러가지 작업을 진행할 때 Claude가 혼란스럽게 이것저것 해보지 않고 CLI만 이용해서 작업하기 때문에 상당한 시간을 절약할 수 있습니다.

물론 이 CLI는 프로덕션용이 아닙니다. 프로덕션용 CLI는 별도로 구성해야 하며 순수 개발용으로 구성해 두는 방식입니다.

## 6. 보조 기억장치는 꼭 있어야 한다

Claude는 만능이 아닙니다.

세션에서 어떤일이 발생했는지, 이 코드는 언제 수정됐는지, 어떤 방법등으로 수정 시도를 했는지 새로운 세션이 시작될때마다 신입사원처럼 물어볼 것입니다.

이걸 최대한 완화하기 위해 시중에는 오픈소스로 된 메모리, 구독형 메모리 등 Claude에서 사용할 수 있는 보조 기억장치가 많이 있습니다.

저는 ChromaDB를 사용하고 있고 이전에 Qdrant, Mem0, Pinecore등 비싸고 좋다는 것도 사용해봤지만, 아직은 ChromaDB로 충분하다고 생각했습니다.

다만 저는 직장과 집, 그리고 모바일 등에서도 전부 동일한 기억을 가지기를 원했고 Chroma Cloud등을 사용할 수 있었지만 가능하면 민감한 부분은 제 관리하에서 작동을 시키고 싶었기에 별도의 프로젝트를 진행했고 얼마전부터 배포를 하고 있습니다.

물론 ChromaDB를 연결해도 Claude가 사용할지 말지는 모르기에 강제성을 주입해야 합니다.

이는 다른 메모리를 사용해도 마찬가지입니다.

## 7. Sentry는 가끔 도움이 된다

Claude는 로그를 “보라고” 할 때만 로그를 확인합니다.

하지만 이것마저도 항상 log 폴더를 세션마다 다르게 생각하고 그 세션의 Claude가 원하는 위치에 로그가 없으면 “로그가 없다”라고 판단하고 자기 마음대로 추측하고 수정을 시작합니다.

물론 Log폴더를 알려주고 마지막 로그를 확인하라고 하면 90%이상 찾아내기는 합니다.

하지만 제가 계속 사용해본 결과, 로그파일은 계속 커질 수 밖에 없기에 필요없는 토큰 낭비가 심합니다.

이 때 유용한게 Sentry입니다.

Sentry는 해당 오류에 대한 Backtrace를 전부 가지고 있기에 필요한 부분만 분석이 가능하도록 해줍니다.

그렇지만 이것도 강제성을 주지 않으면 Sentry를 사용하라고 해도 프로젝트가 여러개 있다면 프로젝트를 찾아볼 생각조차 하지 않고 “찾을 수 없다” 라고 내뱉고 추측으로 진행을 하기는 합니다.

## 8. Claude Think 기능은 가늠할 수 없다

Claude Code에는 일반 모드와 Think 모드가 있습니다.

Think 모드는 Claude가 자기 스스로 생각을 하고 어떤 방향이 좋을지 판단하고 진행을 하도록 하는 중간 가이드 역할을 합니다.

하지만 이 기능도 완벽하지는 않습니다.

때때로 자신의 생각에 너무 심취하거나 추측성 이론을 마구잡이로 가져다 쓰며 말도 안되는 결과물을 내놓기도 합니다.

Think 기능을 사용하기 위해 토큰을 더 사용해야 하는 사용자 입장에서는 복창이 터지는 일입니다.

그래서 이 기능은 Max Plan등을 사용하시는 헤비 유저가 아니라면 대부분 일반 모드로 작업을 하고 전체 프로젝트에 대한 이해 등 많이 복잡한 사항에 대해서만 사용하시는걸 추천해 드립니다.

## 마무리

이 내용이 Claude 또는 다른 AI LLM등을 이용해서 코딩을 하시는 분들께 조금의 도움이라도 되었으면 합니다.

글에서 언급되었던 Claude Hook, Skills, CLI, Memory 샘플은 아래에서 배포중이며 제 프로젝트 기반이라 여러분들 프로젝트에는 조금 수정을 해야할 수 있습니다.

지금 이 시간에도 개발을 하며 Hook 등을 수정하고 있기에 해당 레포지토리는 아마 계속 업데이트를 할 예정입니다. 

이전부터 공개를 해보고 싶었지만 여러가지 귀찮음 및 실 사용자가 있을까에 대한 생각에 배포를 미루고 있었으나, 어느정도 제 마음에 들 정도로 코드가 발전이 되었기에 배포를 해 봅니다.

올 한해 Anthropic에 많은 비용을 지불했고 이제서야 조금 제대로 쓴다는 느낌이 들기에 내용 공유 및 코드 배포를 진행하며, 여러분들의 지갑에 조금의 보탬이 되었으면 합니다.

훅 사용에 대한 질문 및 개선등은 자유롭게 PR이나 Issue로 등록해주시면 감사하겠습니다.

(이 문서 및 코드는 한국어로 생성됐습니다. 영문 번역은 DeepL 번역이며 제가 전달하는 바를 제대로 전달하지 못할 수도 있습니다.)

ChromaDB Remote MCP Server : https://github.com/meloncafe/chromadb-remote-mcp

Claude Hooks : https://github.com/meloncafe/claude-code-hooks